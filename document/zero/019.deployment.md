---
title: 19. 冰刀：部署
---

> 冰缩寒流，川凝冻霭，前回鹭渚冬晚。燕阁红炉，驼峰翠釜，曾忆花柔酒软。――刘天游《氐州第一》

* 项目地址：<https://github.com/silentbalanceyh/vertx-zero-example/>

&ensp;&ensp;&ensp;&ensp;本篇为实战总结帖，主要用于多个项目同时运行时的统一文档，目前Zero上已经运行了几个比较重量级的项目，本文主要针对几个平台从环境搭建、开发、运行、测试到部署进行基于实战的讲解，以Step-By-Step的方式让开发人员能更加流程搭建Zero的企业实战开发环境。本文内容和原始教程中的内容略微有些出入，是因为引用了更多Zero Extension中的模块来辅助开发，所以此文算是Zero Core和Zero Extension的交叉参考教程。

# 「壹」开发环境

## 1.1. 基础环境介绍

&ensp;&ensp;&ensp;&ensp;最新的依赖库版本如下：

|依赖库|类型|版本|
|---|---|---|
|NodeJs|前端|16.14.0|
|Yarn|前端|1.22.17|
|Ant Design|前端|3.26.19|
|React|前端|16.14.0|
|JDK|后端|11|
|Maven|后端|3.8.5|
|Zero|后端|0.8.1 ~|
|Vertx|后端|4.2.6|
|ElasticSearch|集成（全文检索）|7.x ~|
|Neo4j|集成（拓扑图）|4.x ~|
|Camunda|集成（工作流）|7.x ~|
|MySQL|数据库|5.x|
|Oracle|数据库|12.x|
|TiDB|数据库|5.x|

&ensp;&ensp;&ensp;&ensp;**特殊说明**

* JDK的版本推荐使用ZuLu的开源JDK：<https://www.azul.com/downloads/>
* Maven推荐使用mvnd工具：<https://github.com/apache/maven-mvnd/releases>
* 如果使用了**动态建模**（zero-atom）功能，则需要根据您的数据库下载相关依赖库：<https://github.com/silentbalanceyh/vertx-zero/tree/master/vertx-pin/zero-vista>，若是其他类型数据库需参考内置源代码自己写一套基础插件。
* 集成部分的ElasticSearch、Neo4j、Camunda根据您自身项目情况而定。
* **动态建模**/**动态路由**功能根据您自身项目情况而定。
* Maven的仓库推荐使用中心仓库，以防止部分jar包无法从代理仓库下载。

&ensp;&ensp;&ensp;&ensp;本教程**假设**您的基本环境如下：

|实体|必须/可选|类型|含义|
|---|---|---|---|
|本地开发|x|工作目录|~/runtime/develop|
|Maven仓库|x|依赖库目录|~/.m2/repository|
|生产部署|x|工作目录|~/runtime/server|
|生产存储|可选|工作目录|~/runtime/zero-store/|
|`DB_UP`|x|数据表|数据库中的主库|
|`DB_UP_WF`|可选|数据表|数据库中工作流专用库（Camunda库）|
|`DB_UP_HIS`|可选|数据表|数据库中的删除历史库|
|`DB_XX`|可选|数据表|动态建模专用库|

&ensp;&ensp;&ensp;&ensp;**注**：可选部分根据您搭建环境过程中选择的zero extension模块进行相关定义，最新版的模块化会自动化部署相关模块已经环境内容，详细部分参考后续章节。

## 1.2. zero主框架

&ensp;&ensp;&ensp;&ensp;如果您不关注最新版的功能，直接使用`0.8.1`版本，则可**跳过该步骤**，由于zero本身是一个跟着项目成长很迅速的项目，所以在`1.0`版本发布之前，个人推荐紧跟最新版本走。虽然最新版本是`X-SNAPSHOT`，基础功能已经经过了生产环境验证，所以该版本是可靠的；再者，最新版本会包含一部分重用性极高的新功能，如`0.9.0-SNAPSHOT`中引入的：

* 文档管理平台（FTP、SSH）
* 模块化管理平台（License、Modulat）
* 工作流标准化平台（ITSM、ISO）
* WebSocket功能（正在开发中，用于提醒）
* 短信邮件集成

&ensp;&ensp;&ensp;&ensp;zero框架导入的**操作步骤**如下：

1. 进入目录`~/runtime/develop/`中，下载`vertx-zero`代码到环境中：

    ```shell
    # 由于是只读类型，所以可不带access_token的模式拉取开源代码
    ~/runtime/develop >> git clone https://github.com/silentbalanceyh/vertx-zero.git
    # 命令执行后的输出如下
    Cloning into 'vertx-zero'...
    remote: Enumerating objects: 62003, done.
    remote: Counting objects: 100% (17224/17224), done.
    remote: Compressing objects: 100% (6252/6252), done.
    remote: Total 62003 (delta 8657), reused 16131 (delta 8157), pack-reused 44779
    Receiving objects: 100% (62003/62003), 87.48 MiB | 15.39 MiB/s, done.
    Resolving deltas: 100% (35166/35166), done.
    Updating files: 100% (4850/4850), done.
    ```

2. 下载完成后`~/runtime/develop`中会有一个`vertx-zero`目录，使用IDEA导入该目录中的项目：
    * 2.1. 启动IDEA
    ![](./_image/2022-03-27-21-51-08.png)
    * 2.2. 选中下载的`vertx-zero`目录
    ![](./_image/2022-03-27-21-53-09.png)
    * 2.3. 在弹出的对话框中选择`Open as Project`（以项目方式打开）
    ![](./_image/2022-03-27-21-54-08.png)
    * 2.4. 如果弹出下边对话框，则直接勾选`Trust projects in ~/runtime/develop`，然后点击`Trust Project`
    ![](./_image/2022-03-27-21-55-28.png)
    * 2.5. 然后等待右下角的项目初始化完成
    ![](./_image/2022-03-27-21-56-25.png)
    * 2.6. 点开进度条会看到正在执行的后台任务：
    ![](./_image/2022-03-27-21-59-55.png)
    * 2.7. 项目初始化过程中，系统会下载部分所需的Maven依赖包，您的Maven库中会开始有内容（**注：如果之前您的Maven目录中已存在相关库，则可忽略，Demo从空Maven库开始初始化以方便初学者。**）：
    ![](./_image/2022-03-27-21-58-00.png)
3. 导入完成后，先检查IDE中的JDK运行环境是否符合：**File -> Project Structure...**，推荐**11**。
    ![](./_image/2022-03-27-22-16-23.png)
4. 打开Terminal终端，使用内置脚本（**mvnd环境**）编译`vertx-zero`：

    ![](./_image/2022-03-27-22-19-34.png)
    ```shell
    # zero中内置脚本主要用于快速编译以及增量编译框架，其中内容如下：
    # 1）完整编译（常用）                -- zero-compile.sh
    # 2）增量编译                       -- zero-compile-increase.sh
    # 3）「部分」编译核心框架             -- zero-compile-core.sh
    # 4）「部分」编译扩展框架             -- zero-compile-extension.sh
    # 5）「部分」编译插件                -- zero-compile-infix.sh
    # 
    ~/runtime/develop/vertx-zero(master) >> ./zero-compile.sh
    # zero-compile.sh脚本内容如下
    # mvnd clean package install -DskipTests=true -Dmaven.javadoc.skip=true -Dmaven.compile.fork=true -T 1C
    ......
    # 最终输出如下
    [INFO] ------------------------------------------------------------------------
    [INFO] BUILD SUCCESS
    [INFO] ------------------------------------------------------------------------
    [INFO] Total time:  45.021 s (Wall Clock)
    [INFO] Finished at: 2022-03-27T22:32:07+08:00
    [INFO] ------------------------------------------------------------------------
    ```

&ensp;&ensp;&ensp;&ensp;上述步骤的编译不会触发zero的测试流程，如果使用`mvnd clean package install`方式处理，会触发zero的测试流程，使得整个框架编译的时间拉长，所以不推荐`clean package install`方式，这种方式仅留给zero的研发人员使用。编译成功过后，您的开发环境的Maven库中就有了最新的zero版本，目前是`0.9.0-SNAPSHOT`，您就可以执行后续步骤了。

## 1.3. 「可选」zero插件环境

&ensp;&ensp;&ensp;&ensp;如果您在项目中使用了动态建模功能（启用`zero-atom`），此步骤是必须的，动态建模为高级功能，只有在引入主框架的场景下可启用，直接从中心仓库下载的依赖库中并不包含动态建模部分，由于此功能目前依然处于研发阶段，所以只有最新版可支持。

&ensp;&ensp;&ensp;&ensp;**操作步骤**如：

1. 执行Oracle依赖库的安装脚本（动态建模**编译必须**，运行可根据您的项目情况而定）
   
   ```shell
   # 进入 infix-oracle 项目目录
   ~/runtime/develop/vertx-zero(master) » cd vertx-pin/zero-vista/infix-oracle
   # 进入 Maven 本地安装目录
   ~/runtime/develop/vertx-zero/vertx-pin/zero-vista/infix-oracle(master) » cd maven
   # 执行安装脚本
   ~/runtime/develop/vertx-zero/vertx-pin/zero-vista/infix-oracle/maven(master) » ./install-oracle-jar.sh
   # 脚本内容如下
   # mvn install:install-file \
   #     -Dfile=ojdbc7-12.1.0.2.jar \
   #     -DgroupId=com.oracle \
   #     -DartifactId=ojdbc7 \
   #     -Dversion=12.1.0.2 
   #     -Dpackaging=jar
   ```
2. 在Maven窗口中添加新项目：
   ![](./_image/2022-03-28-05-40-21.png)
3. 导入项目`vertx-zero/vertx-pin/zero-vista/`（选择文件）
   ![](./_image/2022-03-28-05-45-35.png)
4. 导入项目后直接编译`zero-vista`：
   ```shell
   ~/runtime/develop/vertx-zero/vertx-pin/zero-vista(master) » mvn clean package install
   .....
   # 最终输出如下
   [INFO] ------------------------------------------------------------------------
   [INFO] Reactor Summary for 「vertx-vista」Scaffold Extension 0.9.0-SNAPSHOT:
   [INFO] 
   [INFO] 「vertx-vista」Scaffold Extension .................... SUCCESS [  1.693 s]
   [INFO] Scaffold Plugin: MySQL（infix-mysql） ................ SUCCESS [  6.121 s]
   [INFO] Scaffold Plugin: Oracle（infix-oracle） .............. SUCCESS [  3.783 s]
   [INFO] ------------------------------------------------------------------------
   [INFO] BUILD SUCCESS
   [INFO] ------------------------------------------------------------------------
   [INFO] Total time:  12.339 s
   [INFO] Finished at: 2022-03-28T05:46:15+08:00
   [INFO] ------------------------------------------------------------------------
   ```
5. 如此您就可以直接在项目中使用动态建模的DDL操作插件了，使用时只需要在`pom.xml`中引入下边片段即可（根据您使用的数据库选择合适的插件）：
    ```xml
        <!-- MySQL -->
        <dependency>
            <groupId>cn.vertxup</groupId>
            <artifactId>infix-mysql</artifactId>
            <version>${zero.version}</version>
        </dependency>
        <!-- Oracle -->
        <dependency>
            <groupId>cn.vertxup</groupId>
            <artifactId>infix-oracle</artifactId>
            <version>${zero.version}</version>
        </dependency>
    ```

## 1.4. 「可选」Github安全设置

> 可直接参考<https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token>

&ensp;&ensp;&ensp;&ensp;由于Github站点升级，当你作为Coordinator加入到项目开发时，新版本已不支持**用户名/密码**方式拉取代码，而是需要在您的账号中生成一个个人的`access_token`，拉取项目代码时需要使用该`access_token`执行代码拉取。

&ensp;&ensp;&ensp;&ensp;其**操作步骤**如下：


1. 登录您的Github个人账号空间，右上角选择**Settings**菜单：
   ![](./_image/2022-03-28-06-09-08.png)
2. 选择左边菜单中最下边的**Developer Settings**：
   ![](./_image/2022-03-28-06-13-40.png)
3. 选择左边菜单**Personal access tokens**，然后点击**Generate new token**按钮
   ![](./_image/2022-03-28-06-15-14.png)
4. 勾选好您所需的权限后直接点击**Genarate token**按钮：
   ![](./_image/2022-03-28-06-17-18.png)
5. 在结果页记录下您的个人token：
   ![](./_image/2022-03-28-06-18-11.png)

6. 进入您的项目环境中，执行如下**操作步骤**进行库关联，先查看目前的远程库版本：

    ```shell
    ~/runtime/develop/vertx-zero(master) » git remote -v
    origin  https://github.com/silentbalanceyh/vertx-zero.git (fetch)
    origin  https://github.com/silentbalanceyh/vertx-zero.git (push)
    ```
7. 您的远程库名称为`origin`，执行如下命令：
   
    ```shell
    ~/runtime/develop/vertx-zero(master) » git remote set-url origin \
        https://<TOKEN>@github.com/silentbalanceyh/vertx-zero.git 
    ```
    注意上述命令的格式，主要是您的token的位置，介于`https://`和`github.com`之间，并且以`@`结尾。
8. 再次查看您的远程库：
    ![](./_image/2022-03-28-06-25-24.png)

&ensp;&ensp;&ensp;&ensp;如此您作为项目的一个Coordinator，基本设置就完成了，当然在后续步骤中您可以直接使用`git clone https://<Token>@<Repo>`的方式拉取代码，**则 6 ~ 8 步骤可省略**。

## 1.5. 项目后端

&ensp;&ensp;&ensp;&ensp;如果是自己从头搭建zero脚手架，则使用**新建**流程，若是导入已经搭建好的项目则使用**导入**流程。

### 1.5.1. 新建

&ensp;&ensp;&ensp;&ensp;新建项目可直接下载最新的脚手架版本：<https://github.com/silentbalanceyh/vertx-zero-scaffold>，然后根据自身项目修改如下内容：

* [ ] 添加hosts映射记录
* [ ] 修改Maven项目标识
* [ ] 修改各个数据库名称、账号、口令
* [ ] 修改容器端口号
* [ ] 修改前端跨域配置
* [ ] 「**数据部分**」修改初始化登录账号
* [ ] 「**数据部分**」修改租户、应用基本信息

&ensp;&ensp;&ensp;&ensp;其中**数据部分**需修改部分Excel文件中的内容，这部分教程在配置章节讲解，上述修改部分参考本教程的配置篇来详细修改，一旦搭建好环境后就不用再变更，为一次性操作。

### 1.5.2. 导入

&ensp;&ensp;&ensp;&ensp;导入项目时如果作为Coordinator需更改项目内容，参考《**1.4.Github安全设置**》先配置个人token，导入的**操作步骤**执行如下（**为了区分，从`vertx-zero-scaffold`中下载的项目在此章节为`smave`名称，从新建到配置完成的部分参考后续各配置章节。**）：

1. 从仓库下载代码（建议直接带token安全下载）：

    ```shell
    git clone https://<Token>@<Repo>
    # 截图中以项目名smave为例，但该项目在私库中，所以读者无法直接访问，读者可直接访问自己创建好的Github仓库
    ```
    ![](./_image/2022-03-28-09-46-41.png)
2. 参考《**1.3.zero插件环境**》直接添加一个新的Maven项目到IDEA环境中，添加完成后效果如：
   ![](./_image/2022-03-28-09-54-27.png)
   **注：vertx-zero和smave共存于一个IDEA窗口中**。
3. 打开终端，执行根目录的编译脚本

    ```shell
    ~/runtime/develop/smave(master) » ./build.sh
    # build.sh（Linux专用）
    # build.bat（Windows专用）
    ```
4. 编译成功后可以看到如下截图（后端基本开发环境就搭建完成了）
   ![](./_image/2022-03-28-09-59-43.png)

### 1.5.3. 初始化

&ensp;&ensp;&ensp;&ensp;Zero脚手架的初始化流程**操作步骤**如下：

1. 为了团队协作开发，先在自己本地开发环境中追加如下hosts映射（**部署时另外配置**）：

    ```shell
    # Mac位置              /private/etc/hosts
    # Windows位置          C:/Windows/System32/drivers/etc/hosts
    127.0.0.1     ox.server.cn      # 容器专用
    127.0.0.1     ox.engine.cn      # 服务专用
    127.0.0.1     ox.integration.cn # 集成专用（可选）
    ```

2. 为您的应用创建MySQL数据库账号：

    ```sql
    CREATE USER 'smave'@'%' IDENTIFIED BY '<PASSWORD>';
    GRANT all privileges ON *.* TO smave@'%' WITH GRANT OPTION;
    ```
3. 执行数据库建库脚本（**账号密码位于脚本 database-reinit.sh，请自行修改，按照第二步创建的账号更改即可，建议一个团队开发账号统一**）

    ```shell
    ~/runtime/develop/smave/script/database(master) » ./database-reinit.sh
    [Zero] 重建数据库成功!
    ```
    重建完成后，可以看到**空库**（文中仅演示了最小配置，不带**工作流库、动态库、删除历史备份库**，其他库的配置参考后续配置章节处理）：
    ![](./_image/2022-03-28-10-15-09.png)
4. 执行初始化脚本，zero中的初始化使用liquibase完成，第3步执行完成后直接运行初始化脚本：

    ```shell
    ~/runtime/develop/smave/sv-driver/ix-smave(master*) » ./run-init.sh
    # 最终输出如下：
    [INFO] ------------------------------------------------------------------------
    [INFO] 
    [INFO] ------------------------------------------------------------------------
    [INFO] BUILD SUCCESS
    [INFO] ------------------------------------------------------------------------
    [INFO] Total time:  7.531 s
    [INFO] Finished at: 2022-03-28T10:20:04+08:00
    [INFO] ------------------------------------------------------------------------
    ```
    执行完初始化脚本后可以在数据库看到生成的表结构：
    ![](./_image/2022-03-28-10-22-42.png)
5. 表创建好过后，执行数据导入专用程序：`cn.vertxup.SvLoader`
   ![](./_image/2022-03-28-10-24-57.png)

6. 「**重要！**」从此处开始，所有直接从IDEA中运行的主程序都必须配置好运行目录，否则无法以正确路径的方式加载数据，该步骤在生产环境中是不需要的，先点击`SvLoader`的运行配置：
   ![](./_image/2022-03-28-10-28-05.png)
7. 「**重要！**」点开运行配置后设置您的主程序的运行目录并保存该配置：
   ![](./_image/2022-03-28-10-29-29.png)

*注意第二个红色框，这一步对开发人员十分重要！*
*注意第二个红色框，这一步对开发人员十分重要！*
*注意第二个红色框，这一步对开发人员十分重要！*

8. 然后点击运行或调试运行执行数据初始化主程序
   ![](./_image/2022-03-28-10-30-46.png)
   运行完成后可看到如下日志：
   ![](./_image/2022-03-28-10-32-08.png)

&ensp;&ensp;&ensp;&ensp;如此，数据初始化就完成了，这个`SvLoader`可以在您更改了任何`/init/oob`中的数据过后执行初始化操作，属于高频使用的主程序，而本小节的**初始化流程**也会在开发过程中反复使用。

### 1.5.3. 启动

&ensp;&ensp;&ensp;&ensp;容器启动流程**操作步骤**如下：

1. 初始化完成后，直接运行主程序：`cn.vertxup.SvAgent`：
   ![](./_image/2022-03-28-10-36-36.png)
2. 主程序运行完成后，后端zero容器就启动了：
   ![](./_image/2022-03-28-10-38-06.png)

## 1.6. 项目前端

&ensp;&ensp;&ensp;&ensp;如果是自己从头搭建zero-ui脚手架，则使用**新建**流程，若是导入已经搭建好的项目则使用**导入**流程。

### 1.6.1. 新建

&ensp;&ensp;&ensp;&ensp;新建zero-ui项目先安装zero的脚本工具：<https://www.vertxai.cn/>，安装好工具之后直接运行如下文档中的命令：<http://www.vertxai.cn/document/doc-web/module-ai.html#.init>。

![](./_image/2022-03-28-10-40-50.png)

&ensp;&ensp;&ensp;&ensp;新建项目后根据自身项目修改如下内容：

* [ ] 项目名称
* [ ] 基础环境变量

### 1.6.2. 导入/启动

&ensp;&ensp;&ensp;&ensp;前端导入使用WebStore，**操作步骤**如下：

1. 从仓库下载代码（建议直接带token安全下载）：

    ```shell
    git clone https://<Token>@<Repo>
    # 截图中以项目名smave-ui为例，但该项目在私库中，所以读者无法直接访问，读者可直接访问自己创建好的Github仓库
    ```
    ![](./_image/2022-03-28-10-45-52.png)
2. 将代码导入WebStorm或其他前端工具IDE中：
   ![](./_image/2022-03-28-10-47-13.png)
3. 选中您下载的项目打开
   ![](./_image/2022-03-28-10-47-58.png)
4. 弹出框中选择
   ![](./_image/2022-03-28-10-48-42.png)
5. 安装本地依赖库（基于`yarn`，一次性执行）
   
    ```shell
    ~/runtime/develop/smave-ui(master) » ./run-update.sh
    ```
    脚本内容如下
    ```shell
    #!/usr/bin/env bash
    ncu -u                              # 检查更新
    node ./scripts/zrun-package.js      # 自动化版本
    rm -rf yarn.lock                    # 删除缓存
    yarn install                        # 安装依赖
    ```
6. 运行启动脚本

   

## 1.7. 启动流程



# 「贰」生产部署

### 1.3.2. 命令工具

### 1.3.3. 后端启动

### 1.3.4. 前端启动



# 「叁」核心配置

### 2.1.1. 端口号和跨域

### 2.1.2. 建库/导入

### 2.1.3. 工作流引擎

### 2.1.4. 开发中心

### 2.1.5. 常用命令

### 2.1.6. 集成配置

# 「肆」开发流程

### 2.2.1. 文档管理

### 2.2.2. 环境管理

### 2.2.3. 模块化配置

### 2.2.4. Auditor配置

### 2.2.5. 调试开关
